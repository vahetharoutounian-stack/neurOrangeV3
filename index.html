<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<meta name="theme-color" content="#000000" />
<title>neurOrange — Home (press-orange to start + quote fade)</title>

<style>
  :root{
    --bergamot:#FFA64D;    /* Bergamot */
    --pantone021:#FE5000;  /* Pantone 021 C */
    --pure:#FFA500;        /* Pure orange */
    --nick:#FF6600;        /* Nickelodeon */
    --afterimage:#F9751F;  /* Afterimage Orange */
    --saffron:#F4C430;     /* Saffron glow */
    --gap-deg:3;
    --inner-thick:34px;
    --outer-thick-mult:2.2;
    --emoji-font:18px;
    --glow:0 0 10px #000, 0 0 18px #000;
    /* audio dock theme tokens */
    --dock:#FF6600;  /* Nickelodeon docking accent */
    --heart:#FFA64D; /* Bergamot used for highlight circle */
    --text:#ffffff; /* White text for buttons */
    --ring:rgba(0,0,0,.35); /* subtle dark ring for outlines */
    /* define spectral and firefox oranges for track buttons */
    --spectral:var(--afterimage);  /* use afterimage orange as spectral orange */
    --firefox:var(--pantone021);   /* use Pantone 021 C as firefox orange */
  }
  *{box-sizing:border-box}
  html,body{
    margin:0; min-height:100%; background:#000; color:#fff;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-font-smoothing:antialiased; overflow:hidden;
  }

  /* === black failsafe (in case video paints late) === */
  #failsafe{position:fixed; inset:0; background:#000; z-index:100000; opacity:1; transition:opacity .25s ease}

  /* === splash: press the orange to start === */
  #intro{
    position:fixed; inset:0; background:#000; display:grid; place-items:center;
    z-index:9999; opacity:1; pointer-events:auto;
    /* extend the fade duration slightly longer to create a smoother transition */
    transition:opacity 2250ms ease;
  }
  #intro.hidden{opacity:0; pointer-events:none}
  .intro-stack{display:grid; justify-items:center; gap:1rem}
  #startOrange{
    font-size:clamp(110px,30vw,240px); line-height:1; user-select:none; cursor:pointer;
    filter:drop-shadow(0 0 26px rgba(0,0,0,.65)) drop-shadow(0 0 50px rgba(255,165,0,.25));
    transition:transform .12s ease;
  }
  #startOrange:active{transform:scale(.98)}
  .intro-title{
    font-weight:900; letter-spacing:.14em; user-select:none;
    font-size:clamp(18px,6.2vw,44px);
    color:var(--bergamot);
    text-shadow:0 0 10px rgba(255,166,77,.55), 0 0 22px rgba(255,165,0,.35);
    animation:titlePulse 2.2s ease-in-out infinite;
  }
  @keyframes titlePulse{
    0%{color:var(--bergamot);text-shadow:0 0 10px rgba(255,166,77,.55),0 0 22px rgba(255,165,0,.35)}
    50%{color:var(--pure);    text-shadow:0 0 14px rgba(255,165,0,.65), 0 0 34px rgba(255,165,0,.45)}
    100%{color:var(--bergamot);text-shadow:0 0 10px rgba(255,166,77,.55),0 0 22px rgba(255,165,0,.35)}
  }

  /* === stage === */
  #phone{position:fixed; inset:0; display:grid; place-items:center}
  #canvas{position:relative; width:100%; height:100%; overflow:hidden; background:#000}

  #brandBar{position:absolute; left:0; right:0; top:10px; display:flex; justify-content:center; z-index:6; filter:drop-shadow(var(--glow))}
  #brand{font-weight:900; letter-spacing:.12em; font-size:clamp(18px,5vw,32px); color:#FFA500}

  #bgLayer{position:absolute; inset:0; z-index:1}
  /* keep hidden until ready */
  #bgVideo{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; opacity:0; transition:opacity .4s ease}
  .fogWrap{position:absolute; inset:-30%; z-index:0; pointer-events:none;
    -webkit-mask-image:radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%);
            mask-image:radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%)}
  .fog{position:absolute; inset:0; mix-blend-mode:screen; filter:blur(60px) saturate(120%);
       background:
         radial-gradient(28% 22% at 20% 30%, var(--nick) 0 55%, transparent 60%),
         radial-gradient(28% 24% at 80% 40%, var(--nick) 0 55%, transparent 60%),
         radial-gradient(30% 22% at 40% 70%, var(--nick) 0 55%, transparent 60%);
       animation:fog1 26s linear infinite alternate; opacity:.62}
  @keyframes fog1{0%{transform:translate(0,0) scale(1)}100%{transform:translate(-3%,-4%) scale(1.08)}}

  #focus{position:absolute; inset:0; display:grid; place-items:center; z-index:2}

  /* start everything shrunk & centered until orange is pressed */
  .wrapCenter{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(1); will-change:transform,opacity}
  .preGrow{transform:translate(-50%,-50%) scale(.05); opacity:0}
  .grow{animation:ringGrow var(--growDur,3600ms) cubic-bezier(.17,.9,.24,1.08) forwards; opacity:0}
  #innerWrap.grow {--growDur:3600ms; animation-delay:0ms}
  #midWrap.grow   {--growDur:4200ms; animation-delay:200ms}
  #outerWrap.grow {--growDur:4600ms; animation-delay:350ms}
  #emojiWrapA.grow{--growDur:4000ms; animation-delay:500ms}
  #emojiWrapB.grow{--growDur:4400ms; animation-delay:650ms}
  @keyframes ringGrow{
    0%   {transform:translate(-50%,-50%) scale(.05) rotate(0deg);   opacity:0}
    60%  {transform:translate(-50%,-50%) scale(1.10) rotate(45deg); opacity:1}
    100% {transform:translate(-50%,-50%) scale(1.00) rotate(0deg);  opacity:1}
  }

  .spin{position:absolute; inset:0}
  .halo{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); border-radius:50%;
        background:radial-gradient(closest-side, rgba(0,0,0,.35), rgba(0,0,0,0)); filter:blur(10px);
        pointer-events:none; z-index:-1}

  /* center prompt */
  #question{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(1);
    display:grid; place-items:center; /* transparent background so no black circle */
    background:transparent; color:#fff; border-radius:50%; border:none;
    z-index:5; filter:drop-shadow(var(--glow)); padding:.4rem .6rem; user-select:none;
    animation:breathe 7s ease-in-out infinite;
  }
  @keyframes breathe{0%,100%{transform:translate(-50%,-50%) scale(1.00)}50%{transform:translate(-50%,-50%) scale(1.02)}}
  #questionText{
    font-weight:900; font-style:italic; text-align:center;
    font-size:clamp(16px,3.6vw,22px); line-height:1.15; margin:0;
    display:inline-block; transform-origin:50% 50%;
    animation:colorPulse 5.5s ease-in-out infinite;
  }
  @keyframes colorPulse{
    0%{color:#fff;text-shadow:0 0 6px rgba(255,255,255,.35)}
    33%{color:var(--bergamot);text-shadow:0 0 8px rgba(255,166,77,.45)}
    66%{color:var(--pure);text-shadow:0 0 8px rgba(255,165,0,.45)}
    100%{color:#fff;text-shadow:0 0 6px rgba(255,255,255,.35)}
  }

  /* ring rotations (running by default; grow effect still from center) */
  #innerSVG,#outerSVG{transform-box:fill-box; transform-origin:50% 50%; animation:spinCW 60s linear infinite}
  #outerSVG{animation-duration:70s}
  @keyframes spinCW{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

  .ghost-wedge{
    fill:var(--c0);
    animation:ghostFlick var(--dur,12s) ease-in-out infinite;
    animation-delay:var(--delay,0s)
  }
  @keyframes ghostFlick{0%,88%,100%{fill:var(--c0)}89%,90%{fill:var(--c1)}}

  #emojiWrapA,#emojiWrapB{z-index:4} .emojiRing{position:absolute; inset:0}
  .emojiSpin{position:absolute; inset:0; animation:spinCCW var(--dur,60s) linear infinite}
  @keyframes spinCCW{from{transform:rotate(0deg)}to{transform:rotate(-360deg)}}
  .emoji{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:var(--emoji-font);
         border:none; border-radius:10px; background:rgba(0,0,0,.08); padding:1px 3px;
         filter:drop-shadow(0 0 8px #000) drop-shadow(0 0 14px #000)}

  /* paintings ring */
  #midWrap{z-index:8}
  #midSpin{animation:spinCCW 56s linear infinite; filter:drop-shadow(var(--glow))}
  #midRing{position:absolute; inset:0}
  .mnode{position:absolute; top:50%; left:50%; border-radius:50%; transform:translate(-50%,-50%);
         background:#111; overflow:hidden; border:1.5px solid #000; filter:drop-shadow(var(--glow));
         cursor:pointer}
  .mnode.withCloud::before{content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:calc(100% + 16px); height:calc(100% + 16px); border-radius:inherit;
    background:radial-gradient(closest-side, rgba(0,0,0,.38), rgba(0,0,0,0)); filter:blur(8px); pointer-events:none}
  .mnode img{width:100%; height:100%; object-fit:cover; display:block; border-radius:50%;
             animation:upright 56s linear infinite; transform-origin:center; backface-visibility:hidden; will-change:transform}
  @keyframes upright{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

  /* bottom nav — tighter; Color Library stays one line */
  .bottomNav{
    position:fixed; left:0; right:0; bottom:calc(env(safe-area-inset-bottom) + 10px);
    z-index:8; display:flex; gap:10px; justify-content:space-between; padding:0 12px;
  }
  .navBtn{
    flex:1; text-align:center; font-weight:900; padding:10px 8px; border-radius:12px;
    border:1px solid rgba(0,0,0,.45); color:#140a00; user-select:none; -webkit-user-select:none; cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.35); text-decoration:none; display:inline-block;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-size:clamp(12px, 3.2vw, 14px); line-height:1.05;
  }
  .navLeft {background:linear-gradient(180deg,#F4C430,#E69B20)}
  .navMid  {background:linear-gradient(180deg,#FF8E00,#FF6A13)}
  .navRight{background:linear-gradient(180deg,#FFA500,#FE5000)}
  .clickable{cursor:pointer}

  /* ===== interstitial quote overlay ===== */
  #interstitial{
    position:fixed; inset:0; background:#000; z-index:10001;
    opacity:0; pointer-events:none; transition:opacity .55s ease;
    display:grid; place-items:center;
  }

  /* === Audio Player UI ===
     A custom mini-player appears after the intro fades.  It contains a play/pause button and a
     volume slider so users can control the ambient soundtrack.  The underlying audio tracks are
     hidden from view; this UI simply manipulates them via JavaScript. */

  /* Restore the central question bubble */
  /* The bubble prompts the user with "What are you feeling?" and remains centered */

  /* Asteroid (comet) styling with orange rainbow smoke trail */
  .comet{ position:absolute; pointer-events:none; z-index:5; }
  /* Stack the comet head (emoji + comet base) vertically and place the smoke tail to the right. */
  .cometStack{
    display:flex;
    align-items:center;
  }
  .cometStack .top{
    /* Reduce the comet head size so asteroids feel smaller */
    /* Shrink comet heads by ~25% */
    font-size:clamp(16px,3.2vw,28px);
    margin-right:6px; /* horizontal gap between head and tail */
    display:flex;
    flex-direction:column;
    align-items:center;
    line-height:1;
    /* ensure the comet head stands out against dark background */
    color:#fff;
    text-shadow:0 0 6px rgba(255,255,255,0.85);
  }
  .cometStack .tail{
    /* create a narrower, tapered smoke trail positioned behind the comet head */
    /* Shrink the smoke trail dimensions accordingly (25% smaller) */
    width:135px;
    height:38px;
    margin-left:10px;
    border-radius:25px;
    /* vivid orange smoke that tapers to transparency */
    background:linear-gradient(to right,
      rgba(255,165,0,0.95) 0%,
      rgba(255,140,0,0.72) 25%,
      rgba(255,102,0,0.5) 55%,
      rgba(255,80,0,0) 100%);
    filter:blur(18px);
    opacity:0.9;
    /* strong glow to make the smoke visible on dark background */
    box-shadow:0 0 16px var(--pure), 0 0 30px var(--nick);
    /* subtle skew for directionality */
    transform:skewX(-18deg);
    animation:smokeFade 6s linear forwards;
  }
  @keyframes smokeFade{
    from{ opacity:0.8; transform:scale(1); }
    to  { opacity:0;   transform:scale(2); }
  }

  /* Comet field spans the entire viewport (not using wrapCenter).
     We set its z-index between the emoji rings and the painting ring so that
     comets can overlap the color/ghost rings but remain behind the artwork. */
  #cometField{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    pointer-events:none;
    overflow:visible;
    z-index:5;
  }
  #interstitial.show{ opacity:1; pointer-events:auto; }
  #interstitialText{
    text-align:center; font-weight:900; font-style:italic;
    font-size:clamp(18px,5.4vw,30px); line-height:1.25; letter-spacing:.01em;
    color:#ffffffcc; padding:0 7vw;
  }
  #interstitialText .accent{
    color:var(--nick);
    animation:
      quoteColor 1.6s linear infinite,
      saffronGlow 1.6s ease-in-out infinite;
  }
  @keyframes quoteColor{
    0%  { color:var(--nick) }
    33% { color:var(--afterimage) }
    66% { color:var(--bergamot) }
    100%{ color:var(--nick) }
  }
  @keyframes saffronGlow{
    0%,100%{ text-shadow: 0 0 10px var(--saffron), 0 0 22px var(--saffron), 0 0 0 var(--nick); }
    50%    { text-shadow: 0 0 16px var(--saffron), 0 0 36px var(--saffron), 0 0 10px var(--nick); }
  }
  /* === Audio Dock ===
     A bottom-left pill dock houses an expand/collapse toggle, a main play/pause button and four
     track sprouts.  Each track has a vertical volume slider that appears above its button when
     active.  The dock respects safe-area insets and remains collapsed by default.  */
  #audioDock{
    position:fixed;
    /* Position the dock above the bottom navigation.  We offset it by roughly the
       nav height (about 60px) plus safe-area so it doesn't overlap the nav. */
    bottom:calc(env(safe-area-inset-bottom) + 90px);
    left:14px;
    display:flex;
    align-items:center;
    padding:8px 10px;
    /* Solid orange backdrop for the dock; remove blur so the color is fully visible */
    background:var(--dock);
    backdrop-filter:none;
    border-radius:30px;
    /* Use the dock color for the border to reinforce the pill */
    border:1px solid var(--dock);
    box-shadow:0 6px 14px rgba(0,0,0,.45);
    z-index:10050;
  }
  #audioDock.collapsed .ad-wrap{
    display:none;
  }
  .ad-toggle{
    width:34px;
    height:34px;
    border-radius:50%;
    background:var(--heart);
    border:2px solid var(--dock);
    color:var(--dock);
    font-size:20px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    position:relative;
    box-shadow:0 0 0 0 rgba(255,102,0,.4);
    transition:transform .15s ease;
  }
  .ad-toggle:active{
    transform:scale(0.96);
  }
  .ad-toggle.pulse{
    animation:adPulse 2.4s infinite;
    /* enlarge the toggle and apply a stronger glow when the dock is expanded */
    transform:scale(1.35);
    /* glowing halo using dock and heart colors */
    box-shadow:0 0 6px 2px var(--heart), 0 0 12px 6px var(--dock);
  }
  @keyframes adPulse{
    0%   { box-shadow:0 0 0 0 rgba(255,102,0,.4); }
    70%  { box-shadow:0 0 0 8px rgba(255,102,0,0); }
    100% { box-shadow:0 0 0 0 rgba(255,102,0,0); }
  }
  .ad-main{
    margin-left:8px;
    width:42px;
    height:42px;
    border-radius:50%;
    background:#fff;
    /* Use dock color for the glyph (white arrow/pause will appear tinted) */
    color:var(--dock);
    font-size:22px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    border:none;
    box-shadow:0 4px 8px rgba(0,0,0,.3);
    transition:transform .15s ease;
  }
  .ad-main:active{
    transform:scale(0.95);
  }
  .ad-wrap{
    position:relative;
    display:flex;
    align-items:flex-end;
    margin-left:10px;
  }
  .ad-btn{
    width:40px;
    height:40px;
    border-radius:50%;
    /* Use spectral orange as the base fill for track buttons */
    background:var(--spectral);
    /* Do not set text color here so that emoji retain their natural colors */
    font-size:24px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    border:none;
    box-shadow:0 4px 8px rgba(0,0,0,.3);
    transition:transform .15s ease;
  }
  .ad-btn:active{
    transform:scale(0.95);
  }
  .ad-btn.active{
    /* When a track is active/playing, fill with firefox orange */
    background:var(--firefox);
    /* Do not override text color here so that emoji retain their natural colors */
  }
  .ad-vol{
    position:absolute;
    bottom:54px;
    left:50%;
    transform:translateX(-50%);
    display:none;
    width:40px;
    padding:6px 4px;
    background:rgba(0,0,0,.55);
    backdrop-filter:blur(8px);
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,.5);
    color:#fff;
    text-align:center;
    z-index:2;
  }
  .ad-vol label{
    display:block;
    font-size:18px;
    margin-bottom:4px;
  }
  .ad-vol input[type='range']{
    width:30px;
    height:130px;
    -webkit-appearance:slider-vertical;
    writing-mode:bt-lr;
    background:transparent;
    margin:0;
    padding:0;
    cursor:pointer;
  }
  .ad-vol input[type='range']::-webkit-slider-runnable-track{
    width:6px;
    height:130px;
    background:var(--dock);
    border-radius:3px;
  }
  .ad-vol input[type='range']::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:18px;
    height:18px;
    border-radius:50%;
    background:#fff;
    border:none;
    box-shadow:0 1px 3px rgba(0,0,0,.4);
    margin-top:-6px;
  }
  .ad-vol input[type='range']::-moz-range-track{
    width:6px;
    height:130px;
    background:var(--dock);
    border-radius:3px;
  }
  .ad-vol input[type='range']::-moz-range-thumb{
    width:18px;
    height:18px;
    border-radius:50%;
    background:#fff;
    border:none;
    box-shadow:0 1px 3px rgba(0,0,0,.4);
  }
  @media (prefers-reduced-motion: reduce){
    .ad-toggle.pulse{ animation:none; }
  }
  .ad-toast{
    position:fixed;
    left:14px;
    bottom:calc(env(safe-area-inset-bottom) + 80px);
    background:rgba(0,0,0,.7);
    color:#fff;
    padding:6px 10px;
    border-radius:8px;
    font-size:13px;
    z-index:10051;
    opacity:0;
    pointer-events:none;
    transition:opacity .3s ease;
  }
</style>
</head>
<body>

<div id="failsafe"></div>

<!-- intro -->
<div id="intro">
  <div class="intro-stack">
    <div id="startOrange" class="intro-emoji" aria-label="Start">🍊</div>
    <div class="intro-title">neurOrange</div>
  </div>
</div>

<div id="phone">
  <div id="canvas">
    <div id="brandBar"><div id="brand">neurOrange</div></div>

    <div id="bgLayer">
      <!-- background video -->
      <video id="bgVideo" muted playsinline webkit-playsinline preload="auto" loop>
        <source src="assets/placeholder.mp4" type="video/mp4" />
      </video>
      <div class="fogWrap"><div class="fog"></div></div>
    </div>

    <div id="focus">
      <!-- outer ghost ring -->
      <div id="outerWrap" class="wrapCenter preGrow">
        <svg id="outerSVG" width="0" height="0" viewBox="0 0 1000 1000" style="position:absolute; inset:0"></svg>
        <div class="halo" id="outerHalo"></div>
      </div>

      <!-- inner bright ring -->
      <div id="innerWrap" class="wrapCenter preGrow">
        <svg id="innerSVG" width="0" height="0" viewBox="0 0 1000 1000" style="position:absolute; inset:0"></svg>
        <div class="halo" id="innerHalo"></div>
      </div>

      <!-- comets / asteroids -->
      <!-- The cometField now fills the viewport and anchors comets at the screen center -->
      <div id="cometField"></div>

      <!-- painting ring -->
      <div id="midWrap" class="wrapCenter preGrow">
        <div id="midSpin" class="spin"><div id="midRing"></div></div>
      </div>

      <!-- emoji rings -->
      <div id="emojiWrapA" class="wrapCenter preGrow"><div class="emojiSpin" style="--dur:56s"><div id="emojiRingA" class="emojiRing"></div></div></div>
      <div id="emojiWrapB" class="wrapCenter preGrow"><div class="emojiSpin" style="--dur:82s; transform: rotate(-12deg)"><div id="emojiRingB" class="emojiRing"></div></div></div>

      <!-- center prompt -->
      <div id="question"><div id="questionText">What are you<br/>feeling?</div></div>
    </div>

    <!-- bottom nav (links to other HTMLs) -->
    <div class="bottomNav">
      <a class="navBtn navLeft"  href="https://vahetharoutounian-stack.github.io/neurOrangeV3/" aria-label="Color Library">Color Library</a>
      <a class="navBtn navMid"   href="https://vahetharoutounian-stack.github.io/neurOrangeV2/" aria-label="Art Gallery">Art Gallery</a>
      <a class="navBtn navRight" href="https://vahetharoutounian-stack.github.io/neurOrangeV3/#step=3" aria-label="Illusion Lab">Illusion Lab</a>
    </div>
  </div>
</div>

<!-- interstitial quote overlay -->
<div id="interstitial" aria-hidden="true">
  <div id="interstitialText"></div>
</div>

<!-- 🎵 Self-contained audio dock.  A bottom-left pill houses an expand toggle, a main play/pause button,
     four track buttons (sparkle, orange, autumn, storm) with volume sliders, and separate audio tags.  -->
<!--
  The audio dock is initially hidden via an inline display:none.  It will be revealed once the orange
  splash screen is dismissed.  The `collapsed` class keeps the dock minimized so only the toggle and
  main control are visible until the user explicitly expands it.  -->
<div id="audioDock" class="collapsed" role="group" aria-label="Audio Player" style="display:none;">
  <button id="adToggle" class="ad-toggle" aria-label="Expand or Collapse" role="button" tabindex="0">🟠</button>
<!-- Main play/pause control.  The glyph will be set via JS.  Default to play symbol with no orange emoji. -->
<button id="adMain" class="ad-main" aria-label="Play/Pause" role="button" tabindex="0">▶</button>

  <div class="ad-wrap">
    <button class="ad-btn" data-track="sparkle" aria-label="Sparkle" role="button" tabindex="0">🌱</button>
    <div class="ad-vol" data-for="sparkle">
      <label>✨</label>
      <input type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Sparkle volume">
    </div>
  </div>
  <div class="ad-wrap">
    <button class="ad-btn" data-track="orange" aria-label="Orange" role="button" tabindex="0">🌱</button>
    <div class="ad-vol" data-for="orange">
      <label>🍊</label>
      <input type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Orange volume">
    </div>
  </div>
  <div class="ad-wrap">
    <button class="ad-btn" data-track="autumn" aria-label="Autumn" role="button" tabindex="0">🌱</button>
    <div class="ad-vol" data-for="autumn">
      <label>🍂</label>
      <input type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Autumn volume">
    </div>
  </div>
  <div class="ad-wrap">
    <button class="ad-btn" data-track="storm" aria-label="Storm" role="button" tabindex="0">🌱</button>
    <div class="ad-vol" data-for="storm">
      <label>⛈️</label>
      <input type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Storm volume">
    </div>
  </div>

  <audio id="aud_sparkle" preload="metadata" playsinline src="tracks/sparkle.mp3" type="audio/mpeg"></audio>
  <audio id="aud_orange"  preload="metadata" playsinline src="tracks/orange.mp3" type="audio/mpeg"></audio>
  <audio id="aud_autumn"  preload="metadata" playsinline src="tracks/autumn.mp3" type="audio/mpeg"></audio>
  <audio id="aud_storm"   preload="metadata" playsinline src="tracks/storm.mp3" type="audio/mpeg"></audio>
</div>

<script>
/* === external destinations (deep links) === */
const URLS = {
  home:   "https://vahetharoutounian-stack.github.io/neurOrange/",
  color:  "https://vahetharoutounian-stack.github.io/neurOrangeV3/",
  gallery:"https://vahetharoutounian-stack.github.io/neurOrangeV2/"
};
function hexNorm(h){return (h||'').replace(/^#/,'').toUpperCase()}
function toColor(hex){ return `${URLS.color}#step=2&cat=standards&hex=${hexNorm(hex)}`; }
function toGallery(idx){ return `${URLS.gallery}#painting=${idx}`; }
function toIllusion(hex){return `${URLS.color}#step=3&cat=ghosts&hex=${hexNorm(hex)}`; }

/* === interstitial quote handling === */
const QUOTES = [
  // Quotes inspired by the color orange.  Each occurrence of the word “orange” is wrapped
  // with a span.accent so it animates in the interstitial overlay.
  "\u201cIt’s funny how the colors of the real world only seem really real when you viddy them on the screen.\u201d — A Clockwork <span class='accent'>Orange</span> (1971)",
  "\u201c<span class='accent'>Orange</span> is the happiest color.\u201d — Frank Sinatra",
  "\u201cThere is no blue without yellow and without <span class='accent'>orange</span>.\u201d — Vincent Van Gogh",
  "\u201cThe <span class='accent'>orange</span> tree took time to create this masterpiece.\u201d — Thich Nhat Hanh",
  "\u201cIf the real world is <span class='accent'>orange</span> juice, then art is like <span class='accent'>orange</span> juice concentrate.\u201d — Martin Mull",
  "\u201cIn a world full of yellows and reds, dare to be <span class='accent'>orange</span>.\u201d"
];
function showQuoteThenGo(url, dwell=1600){
  const overlay = document.getElementById('interstitial');
  const text = document.getElementById('interstitialText');
  text.innerHTML = QUOTES[Math.floor(Math.random()*QUOTES.length)];
  overlay.classList.add('show');
  setTimeout(()=>{ location.href = url; }, dwell);
}

/* === failsafe remove === */
(function(){ const fs=document.getElementById('failsafe'); requestAnimationFrame(()=>{ fs.style.opacity=0; setTimeout(()=>fs.remove(),300); }); })();

/* === palettes === */
const BRIGHT=[{hex:"#FE5000"},{hex:"#FFA500"},{hex:"#FF8E00"},{hex:"#FF6600"},{hex:"#FF6A00"},{hex:"#FF9400"},{hex:"#F28500"},{hex:"#FF7F24"},{hex:"#ED9121"},{hex:"#FFBF00"},{hex:"#FF5E00"},{hex:"#FF6A13"}];
const GHOSTS=["#B36019","#F9751F","#F6B76F","#D2B379","#E3AC47","#F88E10","#C18514","#DE9513","#92752D","#F0CE85","#FCBA45","#D99621","#E8C569","#F0B85F","#D2B265"];
const EMOJIS=["&#128992;","&#129031;","&#128246;","&#128248;","&#129505;","&#127818;","&#129389;","&#129365;","&#127840;","&#127875;","&#127936;","&#128217;"];

/* === helpers === */
function $(id){return document.getElementById(id)}
function $$(sel){return Array.from(document.querySelectorAll(sel))}
function sizeQuestion(){
  const b=$('question'), t=$('questionText');
  b.style.transform='translate(-50%,-50%) scale(1)';
  const w=t.offsetWidth, h=t.offsetHeight, pad=Math.max(6,Math.round(Math.max(w,h)*0.20));
  const D=Math.ceil(Math.max(w,h)+pad*2);
  b.style.width=D+'px'; b.style.height=D+'px';
  startBoundedSpin();
}

/* color math */
function hexToRgb(h){h=h.replace('#',''); if(h.length===3) h=h.split('').map(c=>c+c).join(''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}}
function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b);let h,s,l=(mx+mn)/2;if(mx===mn){h=s=0}else{const d=mx-mn;s=l>0.5?d/(2-mx-mn):d/(mx+mn);switch(mx){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return {h:h*360,s,l}}
function hslToRgb(h,s,l){h/=360;let r,g,b;if(s===0){r=g=b=l}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p},q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return {r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)}}
function rgbToHex(r,g,b){return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('')}
function opponentHex(hex){const {r,g,b}=hexToRgb(hex); const {h,s,l}=rgbToHsl(r,g,b); const opp=(h+180)%360; const {r:rr,g:gg,b:bb}=hslToRgb(opp,s,l); return rgbToHex(rr,gg,bb)}

/* svg wedges */
function wedgePath(cx,cy,r0,r1,a0Deg,a1Deg){const R=d=>d*Math.PI/180; const a0=R(a0Deg),a1=R(a1Deg);
  const P=(r,a)=>({x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)}); const A=P(r1,a0),B=P(r1,a1),C=P(r0,a1),D=P(r0,a0);
  const large=(a1Deg-a0Deg)>180?1:0; return `M ${D.x} ${D.y} L ${A.x} ${A.y} A ${r1} ${r1} 0 ${large} 1 ${B.x} ${B.y} L ${C.x} ${C.y} A ${r0} ${r0} 0 ${large} 0 ${D.x} ${D.y} Z`}

function drawRing(svgEl,sizePx,r0px,r1px,colorObjs,gapDeg){
  svgEl.setAttribute('viewBox','0 0 1000 1000'); svgEl.style.width=sizePx+'px'; svgEl.style.height=sizePx+'px';
  const k=1000/sizePx, r0=Math.max(2,r0px*k), r1=r1px*k, gap=Number(gapDeg)||0;
  const n=colorObjs.length, slice=360/n; svgEl.innerHTML='';
  for(let i=0;i<n;i++){
    const hex=(typeof colorObjs[i]==='string')? colorObjs[i] : colorObjs[i].hex;
    const a0=i*slice, a1=(i+1)*slice-gap;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',wedgePath(500,500,r0,r1,a0,a1));
    p.setAttribute('fill',hex);
    p.setAttribute('stroke','rgba(0,0,0,.18)'); p.setAttribute('stroke-width','1');
    p.classList.add('clickable');
    p.addEventListener('click', ()=> showQuoteThenGo(toColor(hex)), {passive:true});
    svgEl.appendChild(p);
  }
}

function drawGhostRing(svgEl,sizePx,r0px,r1px,ghostHexes,gapDeg){
  svgEl.setAttribute('viewBox','0 0 1000 1000'); svgEl.style.width=sizePx+'px'; svgEl.style.height=sizePx+'px';
  const k=1000/sizePx, r0=Math.max(2,r0px*k), r1=r1px*k, gap=Number(gapDeg)||0;
  const n=ghostHexes.length, slice=360/n; svgEl.innerHTML='';
  for(let i=0;i<n;i++){
    const base=ghostHexes[i], opp=opponentHex(base), a0=i*slice, a1=(i+1)*slice-gap;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',wedgePath(500,500,r0,r1,a0,a1));
    p.classList.add('ghost-wedge','clickable');
    p.style.setProperty('--c0',base); p.style.setProperty('--c1',opp);
    const dur=10+Math.random()*6, phase=Math.random()*dur; p.style.setProperty('--dur',dur.toFixed(2)+'s'); p.style.setProperty('--delay',(-phase).toFixed(2)+'s');
    p.setAttribute('stroke','rgba(0,0,0,.18)'); p.setAttribute('stroke-width','1');
    p.addEventListener('click', ()=> showQuoteThenGo(toIllusion(base)), {passive:true});
    svgEl.appendChild(p);
  }
}

/* paintings */
function buildMidNodes(){
  const mid=$('midRing'); mid.innerHTML='';
  for(let i=1;i<=6;i++){
    const n=document.createElement('div'); n.className='mnode withCloud';
    const img=new Image(); img.alt='Painting '+i; img.src=`assets/paintings/${i}.jpg`;
    img.onerror=()=>{ n.style.background='#222'; };
    n.addEventListener('click', ()=> showQuoteThenGo(toGallery(i)), {passive:true});
    n.appendChild(img); mid.appendChild(n);
  }
}

/* layout */
function layoutRings(){
  const innerSVG=$('innerSVG'), outerSVG=$('outerSVG'), innerWrap=$('innerWrap'), outerWrap=$('outerWrap');
  const midRing=$('midRing'); const W=innerWidth, H=innerHeight, S=Math.min(W,H);
  document.documentElement.style.setProperty('--emoji-font',Math.round(W*0.036)+'px');

  const innerD=Math.round(S*0.58), innerThick=Math.max(16,Math.round(innerD*0.12));
  document.documentElement.style.setProperty('--inner-thick',innerThick+'px');
  innerWrap.style.width=innerD+'px'; innerWrap.style.height=innerD+'px';

  const innerOuter=innerD/2, innerInner=Math.max(2, innerOuter - innerThick*2);
  drawRing(innerSVG, innerD, innerInner, innerOuter, BRIGHT, getComputedStyle(document.documentElement).getPropertyValue('--gap-deg')||3);

  const nodeD=Math.round(innerThick*0.85*5.25*0.82), margin=2, midR=Math.max(0, (W/2)-(nodeD/2)-margin);
  const nodes=$$('#midRing .mnode'), N=6, step=2*Math.PI/N;
  nodes.forEach((n,i)=>{const a=i*step, x=Math.cos(a)*midR, y=Math.sin(a)*midR; n.style.width=nodeD+'px'; n.style.height=nodeD+'px'; n.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`});

  const outerInnerR=midR + nodeD/2 + margin, outerThick=innerThick*(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--outer-thick-mult'))||2.2);
  const outerOuterR=Math.max(outerInnerR+outerThick, W/2+8), outD=Math.round(outerOuterR*2);
  outerWrap.style.width=outD+'px'; outerWrap.style.height=outD+'px';
  drawGhostRing(outerSVG, outD, outerInnerR, outerOuterR, GHOSTS, getComputedStyle(document.documentElement).getPropertyValue('--gap-deg')||3);

  const gap=Math.max(8,Math.round(S*0.014)), rA=outerOuterR+gap, rB=rA+Math.max(22,Math.round(S*0.028));
  placeEmojis('emojiWrapA', rA, 0);
  placeEmojis('emojiWrapB', rB, (Math.PI*2)/(12*2));
  // expose the emoji ring radii globally for simple collision detection with comets
  window.emojiRadii = [rA, rB];
}
function placeEmojis(wrapId,R,phase=0){
  const container=$(wrapId).querySelector('.emojiRing'); container.innerHTML=''; const n=12;
  for(let i=0;i<n;i++){const d=document.createElement('div'); d.className='emoji'; d.innerHTML=EMOJIS[i%EMOJIS.length];
    const a=i*(2*Math.PI/n)+phase, x=Math.cos(a)*R, y=Math.sin(a)*R;
    d.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`; container.appendChild(d);}
}

/* 1 rpm bounded center text (±45°, random flips) */
let spinRAF, spinStarted=false;
function startBoundedSpin(){
  if(spinStarted) return; spinStarted=true;
  const t=$('questionText'); let angle=0, dir=Math.random()<0.5?1:-1; const speed=360/60;
  let change=3+Math.random()*5, last=performance.now();
  function step(now){const dt=(now-last)/1000; last=now; angle+=dir*speed*dt;
    if(angle>45){angle=45;dir=-1} if(angle<-45){angle=-45;dir=1}
    change-=dt; if(change<=0){ if(Math.random()<0.35) dir*=-1; change=3+Math.random()*5; }
    t.style.transform=`rotate(${angle.toFixed(3)}deg)`; spinRAF=requestAnimationFrame(step);}
  spinRAF=requestAnimationFrame(step);
}

/* comets: first in cycle plain, 4th 🌱, 5th 🌹 */
(function comet(){
    const field=$('cometField');
    // update cycle to 7 so that the rose emoji appears every 7th comet and the 6th is a fire emoji
    const cycle=7;
    let count=0;
  function spawn(){
    count++;
    const idx=((count-1)%cycle)+1;
    const W = innerWidth, H = innerHeight;
    // Determine a random direction vector so comets traverse the viewport from one side to the opposite
    const angle = Math.random() * Math.PI * 2;
    const dir = { x: Math.cos(angle), y: Math.sin(angle) };
    // length for traveling beyond the viewport; ensure comets start and end off-screen
    const travel = Math.max(W, H) * 1.4;
    // start and end positions relative to screen center
    let P0 = { x: -dir.x * travel / 2, y: -dir.y * travel / 2 };
    let P1 = { x:  dir.x * travel / 2, y:  dir.y * travel / 2 };
    // Preselect the path type: favour curved trajectories
    let kind;
    {
      const r = Math.random();
      if(r < 0.5)      kind = 'curved';
      else if(r < 0.75) kind = 'offcenter';
      else              kind = 'straight';
    }
    let C;
    // compute a base duration (slowest speed) then divide by a speed factor between 1 and 3 so fastest is triple the speed
    const baseDur = 4.8 + Math.random() * 3; // same range as before
    const speedFactor = 1 + Math.random() * 2; // 1 (slow) to 3 (fast)
    const dur = baseDur / speedFactor;
    if(kind === 'offcenter' || kind === 'curved'){
      // compute normal vector to direction
      const normal = { x: -dir.y, y: dir.x };
      if(kind === 'offcenter'){
        // shift the entire line perpendicular to direction
        const d = (Math.random()*0.35 + 0.15) * (Math.min(W,H)/2);
        const sign = Math.random() < 0.5 ? -1 : 1;
        P0 = { x: P0.x + normal.x * d * sign, y: P0.y + normal.y * d * sign };
        P1 = { x: P1.x + normal.x * d * sign, y: P1.y + normal.y * d * sign };
      } else {
        // curved: compute control point offset along normal at mid point
        const mid = { x: (P0.x + P1.x) / 2, y: (P0.y + P1.y) / 2 };
        const bend = (Math.random()*0.5 + 0.3) * (Math.min(W,H)/2);
        const sign = Math.random() < 0.5 ? -1 : 1;
        C = { x: mid.x + normal.x * bend * sign, y: mid.y + normal.y * bend * sign };
      }
    }
    const comet=document.createElement('div'); comet.className='comet';
    // Anchor each comet at the center of the viewport; we set left/top 50% and then translate via transform
    comet.style.left = '50%';
    comet.style.top  = '50%';
    const stk=document.createElement('div'); stk.className='cometStack';
    const top=document.createElement('div'); top.className='top';
    /* Set comet icon sequence based on a 7-item cycle.  The base rock (🪨) sits below the
       object on top.  The pattern is: 1 bare (rock only), 2 sprout, 3 orange, 4 sprout,
       5 orange, 6 fire, 7 rose. */
    if(idx === 1){
      // bare comet (only the rock)
      top.innerHTML = '<div>🪨</div>';
    } else if(idx === 2){
      // sprout on rock
      top.innerHTML = '<div>🌱</div><div>🪨</div>';
    } else if(idx === 3){
      // orange on rock
      top.innerHTML = '<div>🍊</div><div>🪨</div>';
    } else if(idx === 4){
      // sprout again on rock
      top.innerHTML = '<div>🌱</div><div>🪨</div>';
    } else if(idx === 5){
      // orange again on rock
      top.innerHTML = '<div>🍊</div><div>🪨</div>';
    } else if(idx === 6){
      // fire emoji on rock
      top.innerHTML = '<div>🔥</div><div>🪨</div>';
    } else if(idx === 7){
      // rose on rock
      top.innerHTML = '<div>🌹</div><div>🪨</div>';
    }
    const tail=document.createElement('div'); tail.className='tail';
    stk.appendChild(top);
    stk.appendChild(tail);
    comet.appendChild(stk);
    field.appendChild(comet);
    // Place the rose comet under all content for an unobtrusive path
    if(idx === 7){
      comet.style.zIndex = '1';
    }
    // assign a random rotation speed (degrees per second).  The rose comet (7th) should not rotate.
    const spinRate = (idx === 7) ? 0 : ((10 + Math.random()*30) * (Math.random() < 0.5 ? -1 : 1));
    let t0 = null;
    let lastTime = null;
    let rotSum = 0;
    function lerp(a,b,t){ return a + (b - a) * t; }
    function draw(now){
      if(t0 === null){ t0 = now; lastTime = now; }
      const dt = (now - lastTime) / 1000;
      lastTime = now;
      // total elapsed time since start
      const elapsed = (now - t0) / 1000;
      // normalized progress (0..1)
      const u = Math.min(1, elapsed / dur);
      // warp the progress so comets quickly fly in, ease through the center, then gently fling out.
      // The rose comet travels at a constant pace for a graceful motion.
      let s;
      if(idx === 7){
        // constant linear progress for the rose comet
        s = u;
      } else {
        if(u < 0.5){
          const frac = u / 0.5;
          // accelerate early (power < 1) to fly in faster
          s = 0.5 * Math.pow(frac, 0.4);
        } else {
          const frac = (u - 0.5) / 0.5;
          // ease out smoothly with a moderate exponent
          s = 0.5 + 0.5 * Math.pow(frac, 0.5);
        }
      }
      // compute position along path using warped progress s
      let x, y;
      if(C){
        const one = 1 - s;
        x = one*one*P0.x + 2*one*s*C.x + s*s*P1.x;
        y = one*one*P0.y + 2*one*s*C.y + s*s*P1.y;
      } else {
        x = lerp(P0.x, P1.x, s);
        y = lerp(P0.y, P1.y, s);
      }
      comet.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      // compute spin easing: slow rotation near the center, faster after crossing
      let spinFactor;
      if(u < 0.5){
        const frac = u / 0.5;
        spinFactor = 1 - 0.4 * frac;
      } else {
        const frac = (u - 0.5) / 0.5;
        spinFactor = 0.6 + 0.7 * frac;
      }
      rotSum += spinRate * dt * spinFactor;
      stk.style.transform = `rotate(${rotSum}deg)`;
      if(u < 1){
        requestAnimationFrame(draw);
      } else {
        // After the comet completes its path, allow the smoke trail to linger and fade.
        setTimeout(()=>{ comet.remove(); }, 6000);
      }
    }
    requestAnimationFrame(draw);
  }
  // Launch each comet every 3–5 seconds to ensure frequent sightings
  (function loop(){ spawn(); setTimeout(loop, 3000 + Math.random()*2000); })();
})();

/* build + layout once (no animation yet) */
function layoutAll(){ buildMidNodes(); sizeQuestion(); layoutRings(); }
layoutAll();


/* press the orange to start animation + video */
(function(){
  const orange=$('startOrange');
  orange.addEventListener('click', async ()=>{
    const intro=$('intro');
    // start fading out the intro overlay
    intro.classList.add('hidden');


    // after fade duration, remove intro, reveal audio controls and start video/animations
    setTimeout(()=>{
      intro.remove();
      // reveal the audio dock after the intro fades
      const dockEl = document.getElementById('audioDock');
      if(dockEl){
        // reveal the audio dock once the splash has faded.  Always keep it collapsed at first
        // so only the toggle and main control are shown.
        dockEl.style.display = 'flex';
        dockEl.classList.add('collapsed');
      }

      // autoplay the storm track once audio is unlocked and the dock is visible
      try{
        if(window.adToggleTrack){
          // Start the storm track; it will become active and show its volume slider
          window.adToggleTrack('storm');
          // Mute the melodic tracks (sparkle, orange, autumn) and update their saved volumes and sliders
          ['sparkle','orange','autumn'].forEach(name=>{
            // ensure the track is not selected/active
            if(window.adEnsureInactive) window.adEnsureInactive(name);
            // Set volume to 0 and reset current time to guarantee mute
            const aud=document.getElementById('aud_'+name);
            if(aud){
              aud.pause();
              aud.currentTime = 0;
              aud.volume = 0;
            }
            // persist volume 0 for this track
            try{ localStorage.setItem('advol_'+name, '0'); }catch(_){/* storage may fail in some environments */}
            // update the corresponding slider to reflect muted state
            const volEl=document.querySelector(`#audioDock .ad-vol[data-for="${name}"] input`);
            if(volEl) volEl.value=0;
          });
        }
      }catch(e){/* ignore */}

      const v=$('bgVideo');
      if(v){
        const show=()=>{ v.style.opacity=1; };
        v.addEventListener('loadeddata', show, {once:true});
        v.addEventListener('playing',    show, {once:true});
        const p=v.play();
        if(p && p.catch) p.catch(()=>{});
      }

      // run grow-out from center
      ['innerWrap','midWrap','outerWrap','emojiWrapA','emojiWrapB'].forEach(id=>{
        const el=$(id);
        if(!el) return;
        el.classList.remove('grow');
        el.classList.add('preGrow');
        requestAnimationFrame(()=> el.classList.add('grow'));
      });

    }, 2250); // match the intro fade duration (2.25s)
  }, {passive:true});
})();

/* === Audio Dock Logic ===
   Implements a self-contained audio player dock with expand/collapse, track toggling,
   volume sliders with persistence, concurrency rules (melodic tracks are mutually exclusive,
   storm layers independently), and iOS unlock handling. */
(function(){
  const dock = document.getElementById('audioDock');
  if(!dock) return;
  const ACTIVE = new Set();
  const TRACKS = { sparkle:{group:'melodic'}, orange:{group:'melodic'}, autumn:{group:'melodic'}, storm:{group:'ambient'} };
  const names = Object.keys(TRACKS);
  function audSel(name){ return document.getElementById('aud_'+name); }
  function btnSel(name){ return dock.querySelector(`.ad-btn[data-track="${name}"]`); }
  function volSel(name){ return dock.querySelector(`.ad-vol[data-for="${name}"]`); }
  function anyPlaying(){ for(const name of ACTIVE){ const a=audSel(name); if(a && !a.paused) return true; } return false; }
  function setBtnGlyph(btn,name,active){
    if(active){
      if(name==='sparkle') btn.textContent='✨';
      else if(name==='orange') btn.textContent='🍊';
      else if(name==='autumn') btn.textContent='🍂';
      else if(name==='storm') btn.textContent='⛈️';
    } else {
      btn.textContent='🌱';
    }
  }
  function setMainGlyph(){
    const main=document.getElementById('adMain');
    // Only show play/pause glyphs without the orange emoji
    if(anyPlaying()){
      main.textContent = '⏸';
    } else {
      main.textContent = '▶';
    }
  }
  // restore stored volumes
  names.forEach(name=>{
    const a=audSel(name);
    const vol=volSel(name);
    if(!a||!vol) return;
    const stored=parseFloat(localStorage.getItem('advol_'+name));
    if(!isNaN(stored)){
      a.volume=stored;
      const inp=vol.querySelector('input'); if(inp) inp.value=stored;
    }
  });
  // volume slider events
  names.forEach(name=>{
    const vol=volSel(name);
    if(!vol) return;
    const input=vol.querySelector('input');
    input.addEventListener('input', ()=>{
      const a=audSel(name);
      const val=parseFloat(input.value);
      a.volume=val;
      localStorage.setItem('advol_'+name, val);
    });
    input.addEventListener('change', ()=>{
      const a=audSel(name);
      const val=parseFloat(input.value);
      a.volume=val;
      localStorage.setItem('advol_'+name, val);
    });
  });
  function showToast(msg){
    const toast=document.createElement('div');
    toast.className='ad-toast';
    toast.textContent=msg;
    document.body.appendChild(toast);
    requestAnimationFrame(()=>{ toast.style.opacity=1; });
    setTimeout(()=>{ toast.style.opacity=0; setTimeout(()=>toast.remove(),400); }, 2400);
  }
  let unlocked=false;
  function unlockAudio(){
    if(unlocked) return;
    unlocked=true;
    names.forEach(name=>{
      const a=audSel(name);
      if(!a) return;
      const p=a.play();
      if(p && p.then) p.then(()=>{ a.pause(); a.currentTime=0; }).catch(()=>{});
    });
  }
  window.addEventListener('pointerdown', unlockAudio, {once:true, passive:true});
  function stopOtherMelodic(){
    ['sparkle','orange','autumn'].forEach(name=>{
      if(ACTIVE.has(name)){
        const a=audSel(name);
        a.pause();
        a.currentTime=0;
        ACTIVE.delete(name);
        const btn=btnSel(name);
        btn.classList.remove('active');
        setBtnGlyph(btn,name,false);
        const vol=volSel(name);
        if(vol) vol.style.display='none';
      }
    });
  }

  // Expose a helper to ensure a specific track is not active.  If the track is active,
  // it will be paused, removed from the active set, its button reset to sprout,
  // and its volume slider hidden.  If the track is not active, nothing happens.
  function ensureInactive(name){
    if(!ACTIVE.has(name)) return;
    const a = audSel(name);
    if(a){ a.pause(); a.currentTime = 0; }
    ACTIVE.delete(name);
    const btn = btnSel(name);
    if(btn){ btn.classList.remove('active'); setBtnGlyph(btn,name,false); }
    const vol = volSel(name);
    if(vol) vol.style.display = 'none';
    setMainGlyph();
  }
  // Attach to window so outside code can deactivate tracks
  window.adEnsureInactive = ensureInactive;
  function toggleTrack(name){
    const a=audSel(name);
    const btn=btnSel(name);
    const vol=volSel(name);
    if(ACTIVE.has(name)){
      a.pause();
      ACTIVE.delete(name);
      btn.classList.remove('active');
      setBtnGlyph(btn,name,false);
      if(vol) vol.style.display='none';
    } else {
      if(TRACKS[name].group==='melodic') stopOtherMelodic();
      a.loop = true;
      // Ensure the audio volume reflects the slider value before playing
      if(vol){
        const inp = vol.querySelector('input');
        if(inp){
          const val = parseFloat(inp.value);
          if(!isNaN(val)) a.volume = val;
        }
      }
      a.play().catch(()=>{ showToast(`Couldn't load ${name}.mp3. Check /tracks/.`); });
      ACTIVE.add(name);
      btn.classList.add('active');
      setBtnGlyph(btn,name,true);
      if(vol){
        // Show and initialize the slider with current volume
        vol.style.display='block';
        const inp = vol.querySelector('input');
        if(inp){
          inp.value = a.volume;
        }
      }
    }
    setMainGlyph();
  }
  function resumeAll(){
    ACTIVE.forEach(name=>{
      const a=audSel(name);
      a.play().catch(()=>{});
    });
  }
  function pauseAll(){
    ACTIVE.forEach(name=>{
      const a=audSel(name);
      a.pause();
    });
  }
  document.getElementById('adMain').addEventListener('click', e=>{
    e.stopPropagation();
    if(anyPlaying()){
      pauseAll();
    } else {
      if(ACTIVE.size>0){
        // If there are selected tracks but none playing, resume them
        resumeAll();
      } else {
        // Default to playing the storm track when nothing is active
        toggleTrack('storm');
      }
    }
    setMainGlyph();
  });
  document.getElementById('adToggle').addEventListener('click', e=>{
    e.stopPropagation();
    dock.classList.toggle('collapsed');
    const expanded=!dock.classList.contains('collapsed');
    const toggleBtn=document.getElementById('adToggle');
    if(expanded) toggleBtn.classList.add('pulse');
    else toggleBtn.classList.remove('pulse');
    names.forEach(name=>{
      const vol=volSel(name);
      if(!vol) return;
      if(expanded){
        // show storm volume as an affordance on expand; show active track volumes
        if(name === 'storm' || ACTIVE.has(name)){
          vol.style.display = 'block';
        } else {
          vol.style.display = 'none';
        }
      } else {
        // collapsed: hide all volume popovers
        vol.style.display = 'none';
      }
    });
  });
  names.forEach(name=>{
    const btn=btnSel(name);
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      toggleTrack(name);
    });
    btn.addEventListener('keypress', e=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        toggleTrack(name);
      }
    });
  });
  document.getElementById('adMain').addEventListener('keypress', e=>{
    if(e.key==='Enter' || e.key===' '){
      e.preventDefault();
      document.getElementById('adMain').click();
    }
  });
  document.getElementById('adToggle').addEventListener('keypress', e=>{
    if(e.key==='Enter' || e.key===' '){
      e.preventDefault();
      document.getElementById('adToggle').click();
    }
  });
  // Do not force collapsed here; the dock starts collapsed via markup.  Leaving this call
  // could inadvertently remove the collapsed state if toggled during init.  The markup
  // already applies the `.collapsed` class, so the dock will remain minimized until
  // expanded by the user.
  // dock.classList.add('collapsed');

  // Expose the track toggle function globally so it can be invoked outside this IIFE,
  // e.g. to autoplay the sparkle track after the splash screen.
  window.adToggleTrack = toggleTrack;
})();
</script>
</body>
</html>
